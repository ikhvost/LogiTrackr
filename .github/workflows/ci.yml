name: CI
on: 
  pull_request:
    branches:
      - main

jobs:
    setup:
        name: Setup
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9
                  run_install: false

            - name: Setup node
              uses: actions/setup-node@v4
              with:
                  node-version-file: 'package.json'
                  cache: 'pnpm'
                  cache-dependency-path: '**/pnpm-lock.yaml'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Cache dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      **/node_modules
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-

    build:
        name: Build
        needs: setup
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Setup node
              uses: actions/setup-node@v4
              with:
                  node-version-file: 'package.json'
                  cache: 'pnpm'

            - name: Restore cached dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      **/node_modules
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

            - name: Build project
              run: pnpm run build

    lint:
        name: ESLint
        needs: [setup, build]
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Setup node
              uses: actions/setup-node@v4
              with:
                  node-version-file: 'package.json'
                  cache: 'pnpm'

            - name: Restore cached dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      **/node_modules
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

            - name: Lint
              run: pnpm run lint

    format:
        name: Format
        needs: [setup, build]
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Setup node
              uses: actions/setup-node@v4
              with:
                  node-version-file: 'package.json'
                  cache: 'pnpm'

            - name: Restore cached dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      **/node_modules
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

            - name: Format
              run: pnpm run format

    test:
        name: Test
        needs: [setup, build]
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Setup node
              uses: actions/setup-node@v4
              with:
                  node-version-file: 'package.json'
                  cache: 'pnpm'

            - name: Restore cached dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      **/node_modules
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

            - name: Start database
              run: make db@up

            - name: Test
              run: pnpm run test

            - name: Stop database
              if: ${{ always() }}
              run: make db@down
